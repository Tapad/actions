# PagerDuty
This action adds the ability to trigger [PagerDuty](https://www.pagerduty.com/) incidents.

The intended use case of this is having a scheduled look that reports on situations to alert on. Each line in the report will result in a PagerDuty incident being triggered. 

## Features

- Customize incident title and description using [Mustache](https://github.com/janl/mustache.js) templating.
- Automatically resolve incidents that are no longer relevant.
- Have multiple looks reporting incidents, either connected to the same or different Pagerduty services.

### Mustache templates

All columns in the look are included in the report sent to the action. You can use Mustache templates to refer to these values in the title and description of incidents. E.g. with a report of badly performing sales channels, containing columns *Date*, *Channel Name*, *Actual Amount* and *Expected Minimum Amount*, the title of the incident could be 

> Sales of {{ Actual Amount }} in {{ Channel Name }} on {{ Date }} below minimum {{ Expected Minimum Amount }}

## Setup

### Admin

As a Looker administrator, enable the Action Hub instance that includes the PagerDuty action. 

To be able to call the PagerDuty APIs, it needs a *PagerDuty API Key*. For how to generate a key, please follow instructions at https://support.pagerduty.com/docs/generating-api-keys

### Schedule

When setting up a schedule for a look, enter the following settings: 

#### Where should this data go?

Select the PagerDuty action. 

#### Pagerduty setup form

The Pagerduty form has the following fields: 
- *Service key*: This must be an integration key for you PagerDuty service of type *Events API v2*. It can be found or created at the *Integration* tab of the PagerDuty service page. 
- *De-duplication id column*: The name of a column that uniquely identifies an alert.
- *Unique name or ID of this schedule*: A value that uniquely identifies this schedule. This is used to ensure schedules do not incorrectly resolve alerts generated by other schedules.
- *Enable automatic resolution*: When set to **true**, this will cause incidents that are no longer part of the report to be resolved.
- *Maximum number of incidents*: Maximum number of incidents to create based on a report
- *Summary*: The title of the PagerDuty incident. Use Mustache templating here.
- *Severity*: The severity level of the incidents created.
- *Message*: An additional message to include in incidents. Use Mustache templating here. 

#### Format data as

Select *JSON - Label*

#### Advanced options

If automatic resolution is enabled, *Send this schedule if:* must be set to **there are either results or no results**

## Limitations and considerations

This action has to inspect all services, all open incidents per service and all alerts per open incident to find the information it needs. Therefore it will perform worse with a large number of services and/or open incidents.

PagerDuty may impose [rate limiting](https://developer.pagerduty.com/docs/rest-api-v2/rate-limiting/#:~:text=PagerDuty%20limits%20the%20number%20of,the%20rate%2Dlimited%20API%20request.) if their API is called too often. That will cause this action to fail. This action does not implement backoff and retry, but it does allow users to limit the number of incidents created. Limiting the number of open incidents in the PagerDuty account, incidents that are created at each run of the schedule, and the frequency of the schedule is recommended. 


